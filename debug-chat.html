<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Debug Tool</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .debug-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ccc;
      }
      button {
        padding: 10px 15px;
        margin: 5px;
        cursor: pointer;
      }
      pre {
        background: #f5f5f5;
        padding: 10px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <h1>ðŸ”§ Chat Debug Tool</h1>

    <div class="debug-section">
      <h3>LocalStorage Data</h3>
      <button onclick="showLocalStorage()">Show All localStorage Data</button>
      <button onclick="clearLocalStorage()">Clear All Chat Data</button>
      <pre id="localStorageData"></pre>
    </div>

    <div class="debug-section">
      <h3>Test Conversation Creation</h3>
      <button onclick="createTestConversation()">
        Create Test Conversation
      </button>
      <button onclick="createTestMessage()">Create Test Message</button>
      <pre id="testResults"></pre>
    </div>

    <div class="debug-section">
      <h3>Simulate User Login</h3>
      <input
        type="text"
        id="userEmail"
        placeholder="Enter user email"
        value="reggie@medishure.com"
      />
      <button onclick="simulateUserLogin()">Simulate Login</button>
      <pre id="userData"></pre>
    </div>

    <script>
      function showLocalStorage() {
        const data = {};
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (
            key.startsWith("shared_") ||
            key.includes("conversation") ||
            key.includes("message")
          ) {
            try {
              data[key] = JSON.parse(localStorage.getItem(key));
            } catch (e) {
              data[key] = localStorage.getItem(key);
            }
          }
        }
        document.getElementById("localStorageData").textContent =
          JSON.stringify(data, null, 2);
      }

      function clearLocalStorage() {
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (
            key.startsWith("shared_") ||
            key.includes("conversation") ||
            key.includes("message")
          ) {
            keysToRemove.push(key);
          }
        }
        keysToRemove.forEach((key) => localStorage.removeItem(key));
        alert(`Cleared ${keysToRemove.length} localStorage keys`);
        showLocalStorage();
      }

      function createTestConversation() {
        const conversation = {
          _id: `conv_${Date.now()}_test`,
          contactId: 999,
          contactName: "Test User",
          contactEmail: "test@example.com",
          agentId: "agent123",
          agentName: "Test Agent",
          agentEmail: "agent@example.com",
          status: "active",
          lastMessage: "Test conversation created",
          lastMessageTime: new Date(),
          unreadCount: 0,
          createdAt: new Date(),
          updatedAt: new Date(),
        };

        const conversationsKey = "shared_conversations";
        const existingConversations = JSON.parse(
          localStorage.getItem(conversationsKey) || "[]"
        );
        existingConversations.push(conversation);
        localStorage.setItem(
          conversationsKey,
          JSON.stringify(existingConversations)
        );

        document.getElementById("testResults").textContent =
          "Test conversation created: " + JSON.stringify(conversation, null, 2);
        showLocalStorage();
      }

      function createTestMessage() {
        const message = {
          id: Date.now(),
          text: "Test message",
          sender: "agent",
          timestamp: new Date().toISOString(),
          isRead: false,
          conversationId: "conv_test",
        };

        const messagesKey = "shared_messages_conv_test";
        const existingMessages = JSON.parse(
          localStorage.getItem(messagesKey) || "[]"
        );
        existingMessages.push(message);
        localStorage.setItem(messagesKey, JSON.stringify(existingMessages));

        document.getElementById("testResults").textContent =
          "Test message created: " + JSON.stringify(message, null, 2);
        showLocalStorage();
      }

      function simulateUserLogin() {
        const email = document.getElementById("userEmail").value;
        const user = {
          id: "user_" + Date.now(),
          email: email,
          name: email.split("@")[0],
          role: "user",
        };

        document.getElementById("userData").textContent =
          "Simulated user: " + JSON.stringify(user, null, 2);

        // Show what conversations this user should see
        const conversations = JSON.parse(
          localStorage.getItem("shared_conversations") || "[]"
        );
        const userConversations = conversations.filter(
          (conv) => conv.agentEmail === email || conv.contactEmail === email
        );

        document.getElementById("userData").textContent +=
          "\n\nUser conversations: " +
          JSON.stringify(userConversations, null, 2);
      }

      // Show localStorage data on page load
      showLocalStorage();
    </script>
  </body>
</html>
