<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Album Message Test</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { Download, MoreVertical, Reply, Forward, Copy, Flag, Trash2 } = lucide;

        // PhotoAlbumMessage Component
        const PhotoAlbumMessage = ({ message, currentUser, onDownloadImage, onSaveAll, onReply, onForward, onCopy, onReport, onDelete }) => {
            const [showDropdown, setShowDropdown] = useState(false);
            const [hoveredImage, setHoveredImage] = useState(null);
            const dropdownRef = useRef(null);

            // Close dropdown when clicking outside
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                        setShowDropdown(false);
                    }
                };

                if (showDropdown) {
                    document.addEventListener('mousedown', handleClickOutside);
                }

                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                };
            }, [showDropdown]);

            // Show first 4 images in grid, rest as "+X" overlay
            const displayImages = message.images.slice(0, 4);
            const remainingCount = Math.max(0, message.images.length - 4);

            const handleDownloadImage = (imageUrl, imageName) => {
                if (onDownloadImage) {
                    onDownloadImage(imageUrl, imageName);
                } else {
                    // Fallback download functionality
                    const link = document.createElement('a');
                    link.href = imageUrl;
                    link.download = imageName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            };

            const handleSaveAll = () => {
                if (onSaveAll) {
                    onSaveAll(message.images);
                } else {
                    // Fallback save all functionality
                    message.images.forEach((img, index) => {
                        setTimeout(() => {
                            handleDownloadImage(img.url, img.name);
                        }, index * 100); // Stagger downloads
                    });
                }
            };

            return (
                <div className="flex items-start gap-2.5">
                    {/* User Avatar */}
                    <img 
                        className="w-8 h-8 rounded-full" 
                        src={currentUser?.avatar || "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=32&h=32&fit=crop&crop=face"} 
                        alt={`${currentUser?.name || 'User'} image`}
                    />
                    
                    {/* Message Content */}
                    <div className="flex flex-col gap-1">
                        <div className="flex flex-col w-full max-w-[326px] leading-1.5 p-4 border-gray-200 bg-gray-100 rounded-e-xl rounded-es-xl dark:bg-gray-700">
                            {/* Message Header */}
                            <div className="flex items-center space-x-2 rtl:space-x-reverse mb-2">
                                <span className="text-sm font-semibold text-gray-900 dark:text-white">
                                    {currentUser?.name || 'User'}
                                </span>
                                <span className="text-sm font-normal text-gray-500 dark:text-gray-400">
                                    {message.timestamp}
                                </span>
                            </div>
                            
                            {/* Message Text */}
                            {message.text && (
                                <p className="text-sm font-normal text-gray-900 dark:text-white mb-2">
                                    {message.text}
                                </p>
                            )}
                            
                            {/* Photo Album Grid */}
                            <div className="grid gap-4 grid-cols-2 my-2.5">
                                {displayImages.map((img, index) => (
                                    <div 
                                        key={index}
                                        className="group relative"
                                        onMouseEnter={() => setHoveredImage(index)}
                                        onMouseLeave={() => setHoveredImage(null)}
                                    >
                                        {/* Hover Overlay with Download Button */}
                                        <div className={`absolute w-full h-full bg-gray-900/50 transition-opacity duration-300 rounded-lg flex items-center justify-center ${
                                            hoveredImage === index ? 'opacity-100' : 'opacity-0'
                                        }`}>
                                            <button
                                                onClick={() => handleDownloadImage(img.url, img.name)}
                                                className="inline-flex items-center justify-center rounded-full h-8 w-8 bg-white/30 hover:bg-white/50 focus:ring-4 focus:outline-none dark:text-white focus:ring-gray-50"
                                                title="Download image"
                                            >
                                                <Download className="w-4 h-4 text-white" />
                                            </button>
                                        </div>
                                        <img 
                                            src={img.url} 
                                            alt={`Image ${index + 1}`}
                                            className="rounded-lg w-full h-32 object-cover"
                                        />
                                    </div>
                                ))}
                                
                                {/* Show "+X" overlay for remaining images */}
                                {remainingCount > 0 && (
                                    <div className="group relative">
                                        <button 
                                            className="absolute w-full h-full bg-gray-900/90 hover:bg-gray-900/50 transition-all duration-300 rounded-lg flex items-center justify-center"
                                            onClick={() => {
                                                alert(`Show all ${message.images.length} images`);
                                            }}
                                        >
                                            <span className="text-xl font-medium text-white">+{remainingCount}</span>
                                        </button>
                                        <img 
                                            src={displayImages[0]?.url || 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=200&h=200&fit=crop'} 
                                            alt="More images"
                                            className="rounded-lg w-full h-32 object-cover"
                                        />
                                    </div>
                                )}
                            </div>
                            
                            {/* Message Footer */}
                            <div className="flex justify-between items-center">
                                <span className="text-sm font-normal text-gray-500 dark:text-gray-400">
                                    {message.isRead ? 'Read' : 'Delivered'}
                                </span>
                                <button 
                                    onClick={handleSaveAll}
                                    className="text-sm text-blue-700 dark:text-blue-500 font-medium inline-flex items-center hover:underline"
                                >
                                    <Download className="w-3 h-3 me-1.5" />
                                    Save all
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {/* Dropdown Menu Button */}
                    <button 
                        onClick={() => setShowDropdown(!showDropdown)}
                        className="inline-flex self-center items-center p-2 text-sm font-medium text-center text-gray-900 bg-white rounded-lg hover:bg-gray-100 focus:ring-4 focus:outline-none dark:text-white focus:ring-gray-50 dark:bg-gray-900 dark:hover:bg-gray-800 dark:focus:ring-gray-600" 
                        type="button"
                    >
                        <MoreVertical className="w-4 h-4 text-gray-500 dark:text-gray-400" />
                    </button>
                    
                    {/* Dropdown Menu */}
                    {showDropdown && (
                        <div 
                            ref={dropdownRef}
                            className="absolute z-10 bg-white divide-y divide-gray-100 rounded-lg shadow-sm w-40 dark:bg-gray-700 dark:divide-gray-600" 
                            style={{ marginTop: '40px', marginLeft: '-160px' }}
                        >
                            <ul className="py-2 text-sm text-gray-700 dark:text-gray-200">
                                <li>
                                    <button 
                                        onClick={() => {
                                            onReply?.(message);
                                            setShowDropdown(false);
                                        }}
                                        className="block w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white"
                                    >
                                        <Reply className="w-4 h-4 inline mr-2" />
                                        Reply
                                    </button>
                                </li>
                                <li>
                                    <button 
                                        onClick={() => {
                                            onForward?.(message);
                                            setShowDropdown(false);
                                        }}
                                        className="block w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white"
                                    >
                                        <Forward className="w-4 h-4 inline mr-2" />
                                        Forward
                                    </button>
                                </li>
                                <li>
                                    <button 
                                        onClick={() => {
                                            onCopy?.(message);
                                            setShowDropdown(false);
                                        }}
                                        className="block w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white"
                                    >
                                        <Copy className="w-4 h-4 inline mr-2" />
                                        Copy
                                    </button>
                                </li>
                                <li>
                                    <button 
                                        onClick={() => {
                                            onReport?.(message);
                                            setShowDropdown(false);
                                        }}
                                        className="block w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white"
                                    >
                                        <Flag className="w-4 h-4 inline mr-2" />
                                        Report
                                    </button>
                                </li>
                                <li>
                                    <button 
                                        onClick={() => {
                                            onDelete?.(message);
                                            setShowDropdown(false);
                                        }}
                                        className="block w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white text-red-600 dark:text-red-400"
                                    >
                                        <Trash2 className="w-4 h-4 inline mr-2" />
                                        Delete
                                    </button>
                                </li>
                            </ul>
                        </div>
                    )}
                </div>
            );
        };

        // Test App Component
        const TestApp = () => {
            const [messages, setMessages] = useState([
                {
                    id: 1,
                    text: "This is the new office <3",
                    sender: "agent",
                    timestamp: "11:46",
                    isRead: true,
                    type: "image",
                    images: [
                        {
                            name: "office-1.jpg",
                            url: "https://images.unsplash.com/photo-1497366216548-37526070297c?w=200&h=200&fit=crop",
                            size: 1024000
                        },
                        {
                            name: "office-2.jpg", 
                            url: "https://images.unsplash.com/photo-1497366754035-f200968a6e72?w=200&h=200&fit=crop",
                            size: 856000
                        },
                        {
                            name: "office-3.jpg",
                            url: "https://images.unsplash.com/photo-1497366811353-6870744d04b2?w=200&h=200&fit=crop", 
                            size: 1200000
                        },
                        {
                            name: "office-4.jpg",
                            url: "https://images.unsplash.com/photo-1497366412874-3415097a27e7?w=200&h=200&fit=crop",
                            size: 980000
                        },
                        {
                            name: "office-5.jpg",
                            url: "https://images.unsplash.com/photo-1497366754035-f200968a6e72?w=200&h=200&fit=crop",
                            size: 750000
                        },
                        {
                            name: "office-6.jpg",
                            url: "https://images.unsplash.com/photo-1497366216548-37526070297c?w=200&h=200&fit=crop",
                            size: 1100000
                        }
                    ]
                }
            ]);

            const currentUser = {
                name: "Bonnie Green",
                email: "bonnie@example.com",
                avatar: "https://images.unsplash.com/photo-1494790108755-2616b612b786?w=32&h=32&fit=crop&crop=face"
            };

            const handleDownloadImage = (imageUrl, imageName) => {
                alert(`Downloading: ${imageName}`);
                // In real implementation, this would trigger actual download
            };

            const handleSaveAll = (images) => {
                alert(`Saving all ${images.length} images`);
                // In real implementation, this would download all images
            };

            const handleReply = (message) => {
                alert(`Replying to message: ${message.text}`);
            };

            const handleForward = (message) => {
                alert(`Forwarding message: ${message.text}`);
            };

            const handleCopy = (message) => {
                navigator.clipboard.writeText(JSON.stringify(message));
                alert('Message copied to clipboard!');
            };

            const handleReport = (message) => {
                alert(`Reporting message: ${message.text}`);
            };

            const handleDelete = (message) => {
                if (confirm('Are you sure you want to delete this message?')) {
                    setMessages(messages.filter(m => m.id !== message.id));
                }
            };

            return (
                <div className="max-w-4xl mx-auto">
                    <h1 className="text-3xl font-bold text-gray-900 mb-8 text-center">
                        Photo Album Message Test
                    </h1>
                    
                    <div className="bg-white rounded-lg shadow-lg p-6">
                        <h2 className="text-xl font-semibold mb-4">Sample Photo Album Message</h2>
                        
                        <div className="space-y-4">
                            {messages.map((message) => (
                                <div key={message.id} className="relative">
                                    <PhotoAlbumMessage
                                        message={message}
                                        currentUser={currentUser}
                                        onDownloadImage={handleDownloadImage}
                                        onSaveAll={handleSaveAll}
                                        onReply={handleReply}
                                        onForward={handleForward}
                                        onCopy={handleCopy}
                                        onReport={handleReport}
                                        onDelete={handleDelete}
                                    />
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="mt-8 bg-blue-50 rounded-lg p-6">
                        <h3 className="text-lg font-semibold text-blue-900 mb-2">Features Demonstrated:</h3>
                        <ul className="text-blue-800 space-y-1">
                            <li>• Grid layout for multiple images (2x2 grid)</li>
                            <li>• Hover effects with download buttons</li>
                            <li>• "+X" overlay for additional images</li>
                            <li>• Individual image download functionality</li>
                            <li>• "Save all" button for bulk download</li>
                            <li>• Dropdown menu with Reply, Forward, Copy, Report, Delete options</li>
                            <li>• Responsive design with dark mode support</li>
                            <li>• Click outside to close dropdown</li>
                        </ul>
                    </div>
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<TestApp />, document.getElementById('root'));
    </script>
</body>
</html>
